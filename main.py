from flask import Flask
import threading
import telebot
from yt_dlp import YoutubeDL
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
import os

# Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ Flask
app = Flask('')

# ØªØ¹Ø±ÙŠÙ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
@app.route('/')
def home():
    return "Bot is running!"

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ±
def run():
    app.run(host='0.0.0.0', port=8080)

# Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ø´Ø·Ù‹Ø§
def keep_alive():
    t = threading.Thread(target=run)
    t.start()

# Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ (Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©)
API_TOKEN = os.getenv("TELEGRAM_API_TOKEN", "Ø¶Ø¹_Ø§Ù„ØªÙˆÙƒÙ†_Ù‡Ù†Ø§")  # Ø§Ø³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ± Ø¨ÙŠØ¦ÙŠ Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØªÙˆÙƒÙ†
bot = telebot.TeleBot(API_TOKEN)

# Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø©
channel_url = "https://t.me/Nillionaire_ar"
bot_owner_id = 5592854910  # Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø±Ù‚Ù… ØªØ¹Ø±ÙŠÙÙƒ ÙƒÙ…Ø³ØªØ®Ø¯Ù…

# Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
usage_stats = {
    'total_users': 0,
    'total_downloads': 0,
    'user_downloads': {}
}

# Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©
def is_subscribed(user_id):
    if user_id == bot_owner_id:
        return True
    try:
        status = bot.get_chat_member(chat_id="@Nillionaire_ar", user_id=user_id).status
        return status in ["member", "administrator", "creator"]
    except:
        return False

# ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
def update_stats(user_id):
    usage_stats['total_downloads'] += 1
    if user_id in usage_stats['user_downloads']:
        usage_stats['user_downloads'][user_id] += 1
    else:
        usage_stats['user_downloads'][user_id] = 1
        usage_stats['total_users'] += 1

# ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø§Ø¨Ø·
def detect_platform(url):
    if "youtube.com" in url or "youtu.be" in url:
        return "YouTube"
    elif "instagram.com" in url:
        return "Instagram"
    elif "facebook.com" in url:
        return "Facebook"
    elif "tiktok.com" in url:
        return "TikTok"
    elif "twitter.com" in url:
        return "Twitter"
    else:
        return "Unknown"

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¹ Ø¯Ø¹Ù… Ù…ÙƒØªØ¨Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
def download_with_fallback(url):
    try:
        # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… yt_dlp
        ydl_opts = {
            'outtmpl': 'video.mp4',
            'quiet': True,
            'no_warnings': True,
            'format': 'best'
        }
        with YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])
    except Exception as e:
        try:
            # Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… pytube
            from pytube import YouTube
            yt = YouTube(url)
            stream = yt.streams.get_highest_resolution()
            stream.download(filename="video.mp4")
        except Exception as fallback_error:
            raise Exception(f"ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª. Ø§Ù„Ø®Ø·Ø£: {fallback_error}")

# Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
@bot.message_handler(commands=['start'])
def send_welcome(message):
    if not is_subscribed(message.from_user.id):
        markup = InlineKeyboardMarkup()
        markup.add(InlineKeyboardButton("ğŸ”” Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©", url=channel_url))
        bot.reply_to(
            message,
            "Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨ÙˆØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ [Ø§Ù„Ù‚Ù†Ø§Ø©](https://t.me/Nillionaire_ar).",
            parse_mode="Markdown",
            reply_markup=markup,
        )
        return

    bot.reply_to(
        message,
        (
            "ğŸ‰ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ!\n"
            "Ø£Ù†Ø§ Ø¨ÙˆØª Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù†ØµØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n"
            "ğŸ“Œ **YouTube, Facebook, Instagram, Twitter**\n\n"
            "ğŸ¥ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ùƒ!"
        ),
        parse_mode="Markdown",
    )

# Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
@bot.message_handler(commands=['stats'])
def send_stats(message):
    if message.from_user.id != bot_owner_id:
        bot.reply_to(message, "âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø±.")
        return

    stats_message = (
        f"ğŸ“Š **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**\n"
        f"ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {usage_stats['total_users']}\n"
        f"ğŸ“¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª: {usage_stats['total_downloads']}\n"
    )
    bot.reply_to(message, stats_message, parse_mode="Markdown")

# ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
@bot.message_handler(func=lambda message: not message.text.startswith('/'))
def download_video(message):
    if not is_subscribed(message.from_user.id):
        markup = InlineKeyboardMarkup()
        markup.add(InlineKeyboardButton("ğŸ”” Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©", url=channel_url))
        bot.reply_to(
            message,
            "Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¨ÙˆØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ [Ø§Ù„Ù‚Ù†Ø§Ø©](https://t.me/Nillionaire_ar).",
            parse_mode="Markdown",
            reply_markup=markup,
        )
        return

    url = message.text.strip()

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·
    if not url.startswith("http"):
        bot.reply_to(message, "ğŸš« Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ØµØ§Ù„Ø­.")
        return

    platform = detect_platform(url)
    bot.reply_to(message, f"â³ Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† {platform}ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...")

    try:
        download_with_fallback(url)

        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        with open("video.mp4", 'rb') as video:
            bot.send_video(message.chat.id, video)
            update_stats(message.from_user.id)

        # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        os.remove("video.mp4")
    except Exception as e:
        bot.reply_to(message, f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: {e}")

# Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø®Ø§Ø¯Ù… Ø§Ù„ÙˆÙŠØ¨
keep_alive()

# Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
bot.polling()
